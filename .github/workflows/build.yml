name: Build

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch KernelPatch source
        run: |
          rm -rf third_party/KernelPatch
          git clone --depth=1 https://github.com/bmax121/KernelPatch.git third_party/KernelPatch

      - name: Install Android NDK
        run: |
          cd ~
          wget -q https://dl.google.com/android/repository/android-ndk-r27d-linux.zip
          unzip -q android-ndk-r27d-linux.zip
          echo "ANDROID_NDK=$HOME/android-ndk-r27d" >> $GITHUB_ENV

      - name: Build KPM
        run: |
          TOOLCHAIN="$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64/bin"
          make \
            TARGET_COMPILE="$TOOLCHAIN/llvm-" \
            CC="$TOOLCHAIN/aarch64-linux-android21-clang" \
            LD="$TOOLCHAIN/ld.lld" \
            KP_DIR="$GITHUB_WORKSPACE/third_party/KernelPatch"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hello-kpm
          path: |
            *.kpm
